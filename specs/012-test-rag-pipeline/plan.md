# Implementation Plan: RAG Pipeline Validation Script

**Branch**: `012-test-rag-pipeline` | **Date**: 2025-12-31 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `specs/012-test-rag-pipeline/spec.md`

## Summary

This plan details the technical approach for building a Python-based validation script for the RAG content ingestion pipeline. The script will verify the integrity, coverage, and uniqueness of the data stored in the Qdrant Cloud collection. It will be a standalone, CLI-executable tool that shares the same configuration as the ingestion pipeline.

## Technical Context

**Language/Version**: Python 3.11
**Primary Dependencies**: `qdrant-client`, `requests`, `beautifulsoup4`, `python-dotenv`, `uv`
**Storage**: Qdrant Cloud (Vector Database) - This script reads from Qdrant.
**Testing**: The script itself is the test/validation tool.
**Target Platform**: Any platform with a Python environment.
**Project Type**: Standalone script/backend process.
**Performance Goals**: Complete validation of a full collection in a reasonable timeframe (e.g., under 15 minutes).
**Constraints**: Must operate within the free tiers of Qdrant Cloud.
**Scale/Scope**: Validates a single collection of up to a few hundred pages and several thousand vector records.

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

- [x] **Spec-Driven**: All work is traceable to `specs/012-test-rag-pipeline/spec.md`.
- [x] **Grounding**: The validation script is designed specifically to ensure the book content in the RAG system is correct.
- [x] **Modernity**: The stack uses Qdrant, aligning with the project's principles.
- [x] **Constraints**: The solution is a CLI script and respects the free-tier limitations.

## Project Structure

### Documentation (this feature)

```text
specs/012-test-rag-pipeline/
├── plan.md              # This file
├── research.md          # Research on Qdrant querying for validation
├── data-model.md        # Reference to the consumed data model
├── quickstart.md        # Setup and execution guide for the validation script
├── contracts/           # Not applicable
└── tasks.md             # To be generated by /sp.tasks
```

### Source Code (repository root)

This feature adds a new validation script to the existing `backend` directory.

```text
backend/
├── .env.example
├── .venv/
├── main.py              # Ingestion script (from feature 011)
├── retrieve.py          # Validation script (this feature)
└── pyproject.toml
```

**Structure Decision**: A new script `retrieve.py` is added to the existing `backend/` directory. This co-locates the validation logic with the ingestion logic it is designed to test, promoting code and configuration reuse.

## Phase 0: Research

Technical decisions regarding Qdrant querying (`scroll` API) and a strategy for detecting duplicates have been researched and are documented in `research.md`.

- **Reference**: [research.md](./research.md)

## Phase 1: Design

### Data Model

The validation script consumes the `VectorRecord` data model produced by the ingestion pipeline. No new data models are created.

- **Reference**: [data-model.md](./data-model.md)

### API Contracts

Not applicable. This feature is a backend script and does not expose a public API.

### High-Level Architecture

The validation script (`retrieve.py`) will be a standalone Python script with a clear, modular structure.

1.  **Configuration**: Re-use the `load_config` function (or a similar one) to load settings from the shared `.env` file.
2.  **Sitemap Fetching**: Re-use the `get_sitemap_urls` function to get a list of expected URLs.
3.  **Qdrant Data Retrieval**: Implement a new function, `get_all_qdrant_records`, that uses the `qdrant_client.scroll()` method to fetch all records from the specified collection.
4.  **Validation Functions**:
    - `validate_page_coverage()`: Compares the sitemap URLs with the URLs in the Qdrant records.
    - `validate_metadata()`: Samples records and checks for the presence and format of payload fields.
    - `validate_uniqueness()`: Checks for duplicate records based on payload content.
5.  **Main Orchestration**: A `main()` function will call all validation functions in sequence and print a final summary report to the console, clearly indicating which checks passed or failed.

### Quickstart Guide

A guide for setting up and running the validation script is available in `quickstart.md`.

- **Reference**: [quickstart.md](./quickstart.md)

## Complexity Tracking

No violations of the project constitution were identified. Complexity is low.